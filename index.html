<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Library</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Google Fonts: Lora (untuk nuansa klasik) & Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <!-- Memuat ikon Lucide -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Latar belakang baru: interior perpustakaan */
            background-image: url('https://images.unsplash.com/photo-1521587760476-6c12a4b040da?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        h1, h2, h3, h4, .font-serif {
            font-family: 'Lora', serif;
        }
        /* Overlay cokelat hangat */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(40, 25, 15, 0.7);
            z-index: -1;
        }
        /* Style untuk scrollbar yang lebih halus */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #fdfaf6;
        }
        ::-webkit-scrollbar-thumb {
            background: #a16207; /* amber-700 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #854d0e; /* amber-800 */
        }
        .book-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0; /* Mulai tersembunyi untuk animasi */
            animation: cardFadeIn 0.5s ease-out forwards;
        }
        .book-card:nth-child(2) { animation-delay: 0.1s; }
        .book-card:nth-child(3) { animation-delay: 0.2s; }
        .book-card:nth-child(4) { animation-delay: 0.3s; }
        .book-card:nth-child(5) { animation-delay: 0.4s; }
        .book-card:nth-child(6) { animation-delay: 0.5s; }
        .book-card:nth-child(7) { animation-delay: 0.6s; }
        .book-card:nth-child(8) { animation-delay: 0.7s; }


        .book-card:hover {
            transform: translateY(-12px) rotate(1deg);
            box-shadow: 0 15px 25px rgba(0,0,0,0.2);
        }
        /* Animasi untuk modal */
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        @keyframes cardFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Styling untuk Navigasi Aktif */
        .nav-link {
            transition: all 0.3s ease;
        }
        .nav-link:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .nav-link.active {
            background-color: #a16207; /* amber-700 */
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* Gaya Rak Buku */
        .bookshelf {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 2rem;
            position: relative;
        }
        .bookshelf::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 0;
            right: 0;
            height: 20px;
            background: #4e342e; /* Cokelat tua untuk rak */
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        .admin-tab.active {
            background-color: #fef3c7; /* amber-100 */
            color: #b45309; /* amber-700 */
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased text-gray-200">

    <!-- Login & Register Section -->
    <div id="authOverlay" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="w-full max-w-4xl flex bg-stone-50 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <!-- Panel Kiri (Branding) -->
            <div class="hidden md:block md:w-1/2 bg-cover bg-center p-12 text-white flex flex-col justify-center" style="background-image: url('https://images.unsplash.com/photo-1550399105-c4db5fb85c18?q=80&w=2071&auto=format&fit=crop');">
                <div class="bg-black/50 p-6 rounded-lg">
                    <h2 class="text-3xl font-bold mb-3 font-serif">"Satu buku, satu pena, satu anak, dan satu guru dapat mengubah dunia."</h2>
                    <p class="text-stone-200">Masuk untuk memulai petualangan literasi Anda.</p>
                </div>
            </div>

            <!-- Panel Kanan (Formulir) -->
            <div class="w-full md:w-1/2 p-8 flex flex-col justify-center">
                <div class="text-center mb-6">
                    <img src="logo.png" alt="Logo E-Library" class="w-24 h-24 mx-auto mb-2 rounded-full">
                </div>

                <div id="formContainer" class="relative h-96">
                    <!-- Login Form -->
                    <div id="loginContainer" class="absolute inset-0 transition-all duration-500 ease-in-out opacity-100">
                        <div class="text-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-900 font-serif">Selamat Datang!</h1>
                            <p class="text-gray-500 mt-2">Silakan masuk untuk melanjutkan</p>
                        </div>
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label for="username" class="sr-only">Nama Pengguna</label>
                                <input type="text" id="username" name="username" placeholder="Nama Pengguna" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-amber-600 text-gray-800">
                            </div>
                            <div>
                                <label for="password" class="sr-only">Kata Sandi</label>
                                <input type="password" id="password" name="password" placeholder="Kata Sandi" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-amber-600 text-gray-800">
                            </div>
                            <p id="loginError" class="text-sm text-red-600 hidden">Nama pengguna atau kata sandi salah.</p>
                            <button type="submit" class="w-full bg-amber-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-800 transition-colors">
                                Masuk
                            </button>
                        </form>
                         <p class="text-xs text-center text-gray-400 mt-4">Gunakan <span class="font-semibold">admin/123</span> atau <span class="font-semibold">user/123</span>.</p>
                        <p class="text-sm text-center text-gray-500 mt-4">
                            Belum punya akun? <button id="showRegisterBtn" class="font-semibold text-amber-700 hover:underline focus:outline-none">Daftar di sini</button>
                        </p>
                    </div>
                    
                    <!-- Register Form (Initially Hidden) -->
                    <div id="registerContainer" class="absolute inset-0 transition-all duration-500 ease-in-out opacity-0 pointer-events-none">
                        <div class="text-center mb-6">
                             <h1 class="text-3xl font-bold text-gray-900 font-serif">Buat Akun Baru</h1>
                             <p class="text-gray-500 mt-2">Bergabunglah dengan komunitas pembaca kami</p>
                        </div>
                        <form id="registerForm" class="space-y-4">
                            <div>
                                <label for="regUsername" class="sr-only">Nama Pengguna</label>
                                <input type="text" id="regUsername" name="regUsername" placeholder="Nama Pengguna Baru" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-amber-600 text-gray-800">
                            </div>
                            <div>
                                <label for="regPassword" class="sr-only">Kata Sandi</label>
                                <input type="password" id="regPassword" name="regPassword" placeholder="Kata Sandi Baru" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-amber-600 text-gray-800">
                            </div>
                             <div>
                                <label for="confirmPassword" class="sr-only">Konfirmasi Kata Sandi</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Konfirmasi Kata Sandi" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-amber-600 text-gray-800">
                            </div>
                            <p id="registerError" class="text-sm text-red-600 hidden"></p>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors">
                                Daftar
                            </button>
                        </form>
                        <p class="text-sm text-center text-gray-500 mt-4">
                            Sudah punya akun? <button id="showLoginBtn" class="font-semibold text-amber-700 hover:underline focus:outline-none">Masuk di sini</button>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Main App Content (Initially Hidden) -->
    <div id="app" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">

        <!-- Header -->
        <header class="text-center mb-8 relative flex flex-col items-center">
            <img src="logo.png" alt="Logo E-Library" class="w-32 h-32 mb-4 rounded-full shadow-lg">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 font-serif">
                E-Library
            </h1>
            <div id="userInfo" class="text-lg text-gray-300"></div>
        </header>

        <!-- Main Navigation -->
        <nav class="mb-8 p-2 bg-black/20 backdrop-blur-sm rounded-xl flex flex-wrap justify-center gap-2">
             <button onclick="navigateTo('home')" data-page="home" class="nav-link font-semibold px-4 py-2 rounded-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                Beranda
            </button>
            <button onclick="navigateTo('books')" data-page="books" class="nav-link font-semibold px-4 py-2 rounded-lg flex items-center gap-2">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect width="8" height="4" x="8" y="2" rx="1"></rect></svg>
                Daftar Buku
            </button>
            <button onclick="navigateTo('feedback')" data-page="feedback" class="nav-link font-semibold px-4 py-2 rounded-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path></svg>
                Saran & Masukan
            </button>
            <button onclick="navigateTo('profile')" data-page="profile" class="nav-link font-semibold px-4 py-2 rounded-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" x2="22" y1="10" y2="10"></line></svg>
                Profil Saya
            </button>
        </nav>
        
        <main>
            <!-- Page: Beranda -->
            <div id="page-home" class="page-content">
                <!-- Content generated by JS -->
            </div>

            <!-- Page: Daftar Buku -->
            <div id="page-books" class="page-content hidden">
                <!-- Search and Filter Section -->
                <div class="mb-10 p-6 bg-stone-50/10 backdrop-blur-sm rounded-2xl shadow-md">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="relative flex-grow">
                            <input type="text" id="searchInput" placeholder="Cari berdasarkan judul atau penulis..."
                                   class="w-full pl-12 pr-4 py-3 border border-stone-400 bg-stone-50/80 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow text-gray-800">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            </div>
                        </div>
                        <div class="relative">
                            <select id="categoryFilter" class="w-full md:w-48 appearance-none pl-4 pr-10 py-3 border border-stone-400 bg-stone-50/80 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-shadow text-gray-800">
                                <option value="all">Semua Kategori</option>
                            </select>
                             <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- Book List Section -->
                <div id="bookListContainer" class="space-y-16">
                    <!-- Bookshelves will be rendered here by JS -->
                </div>
                <div id="noResults" class="hidden text-center py-12">
                    <p class="text-xl text-gray-300">Buku tidak ditemukan.</p>
                </div>
            </div>

            <!-- Page: Feedback -->
            <div id="page-feedback" class="page-content hidden">
                <!-- Content generated by JS -->
            </div>

            <!-- Page: Profile -->
            <div id="page-profile" class="page-content hidden">
                <!-- Content generated by JS -->
            </div>

        </main>

    </div>

    <!-- Modal for Book Details -->
    <div id="bookModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div id="modalContent" class="bg-stone-50 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-8 relative modal-enter text-gray-800">
            <!-- Konten detail buku akan ditampilkan di sini -->
        </div>
    </div>
    
    <!-- Modal for Admin Panel -->
    <div id="adminPanelModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-stone-50 rounded-2xl shadow-2xl w-full max-w-7xl h-[90vh] flex overflow-hidden modal-enter text-gray-800">
            <!-- Sidebar Navigation -->
            <div class="w-64 bg-stone-100 p-6 flex flex-col">
                <h2 class="text-2xl font-bold font-serif text-stone-800 mb-6">Panel Admin</h2>
                <nav class="flex-grow flex flex-col space-y-2">
                    <button id="tabDashboard" onclick="switchTab('dashboard')" class="admin-tab w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-stone-600 hover:bg-stone-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                        Dashboard
                    </button>
                    <button id="tabBooks" onclick="switchTab('books')" class="admin-tab w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-stone-600 hover:bg-stone-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                        Kelola Buku
                    </button>
                    <button id="tabUsers" onclick="switchTab('users')" class="admin-tab w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-stone-600 hover:bg-stone-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Kelola Pengguna
                    </button>
                    <button id="tabFeedback" onclick="switchTab('feedback')" class="admin-tab w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-stone-600 hover:bg-stone-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        Kelola Masukan
                    </button>
                    <button id="tabBorrowedBooks" onclick="switchTab('borrowedBooks')" class="admin-tab w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-stone-600 hover:bg-stone-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 13 5 5-5 5"/><path d="M4 18v-1a4 4 0 0 1 4-4h10"/><path d="m7 7-5 5 5 5"/><path d="M20 6V5a4 4 0 0 0-4-4H8"/></svg>
                        Buku Dipinjam
                    </button>
                    <button id="tabBorrowHistory" onclick="switchTab('borrowHistory')" class="admin-tab w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-stone-600 hover:bg-stone-200 transition-colors">
                       <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
                        Riwayat Pinjam
                    </button>
                    <button id="tabLoginHistory" onclick="switchTab('loginHistory')" class="admin-tab w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-stone-600 hover:bg-stone-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                        Riwayat Login
                    </button>
                </nav>
            </div>
            
            <!-- Main Content Area -->
            <div class="flex-1 p-8 overflow-y-auto">
                <button onclick="closeAdminPanel()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                
                <!-- Content for Dashboard Tab -->
                <div id="contentDashboard" class="admin-tab-content">
                    <!-- Content generated by JS -->
                </div>
                
                <!-- Content for Books Tab -->
                <div id="contentBooks" class="admin-tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold font-serif text-stone-800">Kelola Koleksi Buku</h2>
                        <button onclick="openBookForm()" class="bg-amber-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-800 transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path><path d="M12 10v6"></path><path d="M9 13h6"></path></svg>
                            Tambah Buku
                        </button>
                    </div>
                    <div id="adminBookList" class="pr-2"></div>
                </div>

                <!-- Content for Users Tab -->
                <div id="contentUsers" class="admin-tab-content hidden">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold font-serif text-stone-800">Kelola Pengguna</h2>
                    </div>
                    <div id="adminUserList" class="pr-2"></div>
                </div>
                
                <!-- Content for Feedback Tab -->
                <div id="contentFeedback" class="admin-tab-content hidden">
                    <h2 class="text-3xl font-bold font-serif text-stone-800 mb-6">Kelola Saran & Masukan</h2>
                    <div id="adminFeedbackList" class="pr-2"></div>
                </div>

                <!-- Content for Borrowed Books Tab -->
                <div id="contentBorrowedBooks" class="admin-tab-content hidden">
                    <h2 class="text-3xl font-bold font-serif text-stone-800 mb-6">Buku Sedang Dipinjam</h2>
                    <div id="adminBorrowedBooksList" class="pr-2"></div>
                </div>

                <!-- Content for Borrow History Tab -->
                <div id="contentBorrowHistory" class="admin-tab-content hidden">
                    <h2 class="text-3xl font-bold font-serif text-stone-800 mb-6">Riwayat Peminjaman</h2>
                    <div id="adminBorrowHistoryList" class="pr-2"></div>
                </div>

                <!-- Content for Login History Tab -->
                <div id="contentLoginHistory" class="admin-tab-content hidden">
                    <h2 class="text-3xl font-bold font-serif text-stone-800 mb-6">Riwayat Login</h2>
                    <div id="adminLoginHistoryList" class="pr-2"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Add/Edit Book Form -->
    <div id="bookFormModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[70] hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto p-8 relative modal-enter text-gray-800">
             <button onclick="closeBookForm()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h2 id="bookFormTitle" class="text-2xl font-bold mb-6 text-center font-serif">Tambah Buku Baru</h2>
            <form id="bookForm" class="space-y-4">
                <input type="hidden" name="id">
                <input type="text" name="title" placeholder="Judul Buku" required class="w-full p-3 border rounded-lg text-gray-800">
                <input type="text" name="author" placeholder="Penulis" required class="w-full p-3 border rounded-lg text-gray-800">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="number" name="year" placeholder="Tahun Terbit" required class="w-full p-3 border rounded-lg text-gray-800">
                    <input type="number" name="pages" placeholder="Jumlah Halaman" required class="w-full p-3 border rounded-lg text-gray-800">
                    <input type="text" name="category" placeholder="Kategori" required class="w-full p-3 border rounded-lg text-gray-800">
                </div>
                 <!-- Cover input with preview -->
                <div>
                    <label for="coverInput" class="block text-sm font-medium text-gray-700 mb-1">Unggah Sampul Buku</label>
                    <input type="file" id="coverInput" name="coverFile" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100 cursor-pointer">
                    <input type="hidden" name="cover">
                    <div class="mt-4 text-center">
                        <img id="coverPreview" src="https://placehold.co/200x300/e2e8f0/94a3b8?text=Pratinjau+Sampul" alt="Pratinjau Sampul" class="mx-auto max-h-48 w-auto object-cover rounded-lg border shadow-sm">
                    </div>
                </div>
                <div class="relative">
                    <textarea name="summary" placeholder="Sinopsis" required class="w-full p-3 border rounded-lg h-24 text-gray-800"></textarea>
                    <button type="button" id="generateSynopsisBtn" class="absolute bottom-2 right-2 bg-stone-700 text-white text-xs font-bold py-1 px-2 rounded-md hover:bg-stone-800 transition-colors flex items-center disabled:bg-stone-400">
                        <span id="synopsisBtnText">Buat Sinopsis <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block ml-1 -mt-1"><path d="M12 2L9 9l-7 3 7 3 3 7 3-7 7-3-7-3z"/></svg></span>
                        <svg id="synopsisSpinner" class="animate-spin h-4 w-4 text-white hidden ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24" 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
                <button id="bookFormSubmitBtn" type="submit" class="w-full bg-amber-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-800 transition-colors">
                    Tambah Buku
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal for User History (Admin View) -->
    <div id="userHistoryModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[75] hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col p-8 relative modal-enter text-gray-800">
            <button onclick="closeUserHistoryModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h2 id="userHistoryModalTitle" class="text-2xl font-bold mb-6 font-serif">Riwayat Peminjaman Pengguna</h2>
            <div id="userHistoryModalContent" class="flex-grow overflow-y-auto pr-2 space-y-3">
                <!-- Content generated by JS -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Delete -->
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[80] hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center modal-enter text-gray-800">
            <h3 class="text-xl font-bold mb-4 font-serif">Konfirmasi Hapus</h3>
            <p id="confirmDeleteText" class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus buku ini?</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Batal</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Modal for Logout Confirmation -->
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[80] hidden">
        <div class="bg-stone-50 rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center modal-enter text-gray-800">
            <h3 class="text-2xl font-bold mb-4 font-serif">Sampai Jumpa Lagi!</h3>
            <p id="logoutMessage" class="text-gray-600 mb-6">Apakah Anda yakin ingin keluar dari sesi ini?</p>
            <div class="flex justify-center gap-4">
                <button id="cancelLogoutBtn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Batal</button>
                <button id="confirmLogoutBtn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Keluar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-500 ease-in-out z-[90]">
        <!-- Pesan notifikasi akan muncul di sini -->
    </div>

    <!-- Notifications Panel -->
    <div id="notificationsPanel" class="absolute top-20 right-4 sm:right-6 lg:right-8 w-full max-w-sm bg-white text-gray-800 rounded-2xl shadow-xl border hidden z-[85]">
        <div class="p-4 border-b">
            <h3 class="font-bold font-serif">Notifikasi</h3>
        </div>
        <div id="notificationList" class="p-2 max-h-80 overflow-y-auto">
            <!-- Notifications will be rendered here -->
        </div>
    </div>


    <script>
        // --- STATE MANAGEMENT ---
        let currentUser = null; // { username: string, role: string }
        let bookToEditId = null;
        let bookToDeleteId = null;
        let notifications = [];

        // --- DUMMY DATA ---
        let users = [
            { username: "admin", password: "123", role: "admin" },
            { username: "user", password: "123", role: "user" }
        ];

        let books = [
            { id: 1, title: "Laskar Pelangi", author: "Andrea Hirata", year: 2005, pages: 529, category: "Fiksi", cover: "https://placehold.co/400x600/6366f1/ffffff?text=Laskar+Pelangi", summary: "Kisah inspiratif tentang perjuangan 10 anak dari keluarga miskin yang bersekolah di sebuah sekolah Muhammadiyah di Belitung yang penuh dengan keterbatasan.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 2, title: "Bumi Manusia", author: "Pramoedya Ananta Toer", year: 1980, pages: 535, category: "Sejarah", cover: "https://placehold.co/400x600/ec4899/ffffff?text=Bumi+Manusia", summary: "Novel ini menceritakan tentang perjalanan seorang pemuda Jawa bernama Minke di akhir abad ke-19, di tengah pusaran perubahan sosial dan politik Hindia Belanda.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 3, title: "Cantik Itu Luka", author: "Eka Kurniawan", year: 2002, pages: 480, category: "Sastra", cover: "https://placehold.co/400x600/f59e0b/ffffff?text=Cantik+Itu+Luka", summary: "Sebuah epik keluarga yang membentang dari zaman kolonial hingga kemerdekaan, memadukan sejarah, mitos, dan kekerasan dengan gaya realisme magis.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 6, title: "Negeri 5 Menara", author: "Ahmad Fuadi", year: 2009, pages: 423, category: "Fiksi", cover: "https://placehold.co/400x600/3b82f6/ffffff?text=Negeri+5+Menara", summary: "Kisah tentang Alif, seorang anak dari Minangkabau yang merantau ke Pondok Madani di Jawa Timur dan menemukan arti persahabatan serta impian.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 7, title: "Ronggeng Dukuh Paruk", author: "Ahmad Tohari", year: 1982, pages: 400, category: "Sastra", cover: "https://placehold.co/400x600/84cc16/ffffff?text=Ronggeng+Dukuh+Paruk", summary: "Kisah tentang Srintil, seorang penari ronggeng di dusun kecil yang terpencil, dan lika-liku kehidupannya yang terjalin dengan peristiwa politik tragis di Indonesia.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 8, title: "Laut Bercerita", author: "Leila S. Chudori", year: 2017, pages: 379, category: "Fiksi Sejarah", cover: "https://placehold.co/400x600/22d3ee/ffffff?text=Laut+Bercerita", summary: "Sebuah novel yang menyuarakan kisah para aktivis mahasiswa yang hilang pada tahun 1998, diceritakan dari sudut pandang Biru Laut dan keluarganya yang mencari kebenaran.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 9, title: "Gadis Kretek", author: "Ratih Kumala", year: 2012, pages: 274, category: "Fiksi Sejarah", cover: "https://placehold.co/400x600/a855f7/ffffff?text=Gadis+Kretek", summary: "Mengungkap sejarah industri kretek di Indonesia melalui pencarian seorang sekarat akan Jeng Yah, seorang perempuan misterius dari masa lalunya.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 10, title: "Dilan: Dia adalah Dilanku Tahun 1990", author: "Pidi Baiq", year: 2014, pages: 332, category: "Romantis", cover: "https://placehold.co/400x600/fb7185/ffffff?text=Dilan+1990", summary: "Kisah cinta remaja antara Dilan dan Milea di Bandung pada tahun 1990-an dengan gaya bahasa yang unik dan gombalan yang khas.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 11, title: "Geez & Ann", author: "Rintik Sedu", year: 2017, pages: 328, category: "Romantis", cover: "https://placehold.co/400x600/c084fc/ffffff?text=Geez+%26+Ann", summary: "Kisah cinta jarak jauh antara Geez dan Ann yang penuh dengan rindu, komitmen, dan tantangan yang menguji hubungan mereka.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 12, title: "Mariposa", author: "Luluk HF", year: 2018, pages: 484, category: "Romantis", cover: "https://placehold.co/400x600/60a5fa/ffffff?text=Mariposa", summary: "Kisah Acha yang berusaha mendapatkan hati Iqbal, seorang laki-laki dingin dan pintar yang sulit didekati, layaknya kupu-kupu Mariposa.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 13, title: "Antares", author: "Ravaluc", year: 2020, pages: 344, category: "Fiksi Remaja", cover: "https://placehold.co/400x600/f87171/ffffff?text=Antares", summary: "Kisah Zea yang tanpa sengaja terlibat dalam kehidupan Antares, ketua geng motor Calderioz, yang membawanya ke dalam dunia yang penuh bahaya dan romansa.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 14, title: "Santri Pilihan Bunda", author: "Sisca H. P.", year: 2021, pages: 368, category: "Religi", cover: "https://placehold.co/400x600/4ade80/ffffff?text=Santri+Pilihan+Bunda", summary: "Cerita tentang Aliza, seorang mahasiswi yang harus menerima perjodohan dengan Kinaan, seorang santri pilihan ibunya, dan belajar untuk saling menerima.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 15, title: "Wingit", author: "Sara Wijayanto", year: 2021, pages: 200, category: "Horor", cover: "https://placehold.co/400x600/4b5563/ffffff?text=Wingit", summary: "Kumpulan cerita horor berdasarkan pengalaman Sara Wijayanto dalam berinteraksi dengan makhluk tak kasat mata di berbagai tempat angker.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 16, title: "Sumur", author: "Eka Kurniawan", year: 2021, pages: 120, category: "Horor", cover: "https://placehold.co/400x600/1e293b/ffffff?text=Sumur", summary: "Sebuah novel pendek yang mencekam tentang teror yang datang dari sebuah sumur tua di belakang rumah, menggali ketakutan yang paling dalam.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 17, title: "Si Putih", author: "Tere Liye", year: 2021, pages: 432, category: "Fantasi", cover: "https://placehold.co/400x600/e2e8f0/1e293b?text=Si+Putih", summary: "Bagian dari serial Bumi karya Tere Liye, menceritakan petualangan Si Putih, seekor kucing kuno dari Klan Bulan, dalam dunia paralel yang penuh keajaiban.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 18, title: "Kekasih Musim Gugur", author: "Laksmi Pamuntjak", year: 2020, pages: 400, category: "Romantis", cover: "https://placehold.co/400x600/f97316/ffffff?text=Kekasih+Musim+Gugur", summary: "Kisah cinta yang kompleks antara Sael, seorang pembuat peta, dan Maya, seorang seniman, yang terbentang melintasi waktu dan geografi.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 19, title: "The Midnight Library", author: "Matt Haig", year: 2020, pages: 304, category: "Misteri", cover: "https://placehold.co/400x600/14b8a6/ffffff?text=The+Midnight+Library", summary: "Antara hidup dan mati, ada sebuah perpustakaan di mana setiap buku menawarkan kesempatan untuk mencoba kehidupan lain yang mungkin bisa dijalani.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 20, title: "Pembunuhan di Nihonbashi", author: "Keigo Higashino", year: 2011, pages: 352, category: "Misteri", cover: "https://placehold.co/400x600/9333ea/ffffff?text=Pembunuhan+di+Nihonbashi", summary: "Detektif Kaga Kyoichiro menyelidiki kasus pembunuhan yang rumit di distrik Nihonbashi, Tokyo, di mana setiap petunjuk terhubung dengan toko-toko tradisional di sana.", status: "available", borrowedBy: null, borrowedAt: null },
            { id: 21, title: "Perahu Kertas", author: "Dee Lestari", year: 2009, pages: 444, category: "Fantasi", cover: "https://placehold.co/400x600/3b82f6/ffffff?text=Perahu+Kertas", summary: "Kisah tentang Kugy, seorang gadis yang percaya pada dongeng dan perahu kertas, dan Keenan, seorang pelukis berbakat, dalam perjalanan mereka menemukan cinta dan impian.", status: "available", borrowedBy: null, borrowedAt: null }
        ];
        
        let feedback = [
            { id: 1, username: "user", category: "Saran Fitur", message: "Aplikasi ini akan lebih baik jika ada fitur bookmark untuk menandai halaman terakhir yang dibaca.", timestamp: "2025-10-12T10:00:00Z", status: "new" },
            { id: 2, username: "admin", category: "Laporan Bug", message: "Gambar sampul untuk buku 'Bumi Manusia' kadang tidak muncul di halaman utama.", timestamp: "2025-10-11T14:30:00Z", status: "read" }
        ];

        let loginHistory = [];
        let borrowHistory = []; // { id, username, bookId, bookTitle, borrowedAt, returnedAt }
        
        // --- DOM ELEMENTS ---
        const authOverlay = document.getElementById('authOverlay');
        const appContainer = document.getElementById('app');
        const loginContainer = document.getElementById('loginContainer');
        const registerContainer = document.getElementById('registerContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        
        const pageContents = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageHome = document.getElementById('page-home');
        const pageFeedback = document.getElementById('page-feedback');
        const pageProfile = document.getElementById('page-profile');
        
        const bookListContainer = document.getElementById('bookListContainer');
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const noResults = document.getElementById('noResults');

        const bookModal = document.getElementById('bookModal');
        const modalContent = document.getElementById('modalContent');
        
        const toast = document.getElementById('toast');
        const userInfo = document.getElementById('userInfo');

        const adminPanelModal = document.getElementById('adminPanelModal');
        const adminBookList = document.getElementById('adminBookList');
        const adminUserList = document.getElementById('adminUserList');
        const adminFeedbackList = document.getElementById('adminFeedbackList');
        const adminBorrowedBooksList = document.getElementById('adminBorrowedBooksList');
        const adminBorrowHistoryList = document.getElementById('adminBorrowHistoryList');
        const adminLoginHistoryList = document.getElementById('adminLoginHistoryList');
        const adminTabs = document.querySelectorAll('.admin-tab');
        const adminTabContents = document.querySelectorAll('.admin-tab-content');

        const bookFormModal = document.getElementById('bookFormModal');
        const bookForm = document.getElementById('bookForm');
        const bookFormTitle = document.getElementById('bookFormTitle');
        const bookFormSubmitBtn = document.getElementById('bookFormSubmitBtn');
        const coverInput = document.getElementById('coverInput');
        const coverPreview = document.getElementById('coverPreview');
        const generateSynopsisBtn = document.getElementById('generateSynopsisBtn');

        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const confirmDeleteText = document.getElementById('confirmDeleteText');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        const userHistoryModal = document.getElementById('userHistoryModal');
        const userHistoryModalTitle = document.getElementById('userHistoryModalTitle');
        const userHistoryModalContent = document.getElementById('userHistoryModalContent');

        const notificationsPanel = document.getElementById('notificationsPanel');
        const notificationList = document.getElementById('notificationList');
        
        const logoutModal = document.getElementById('logoutModal');
        const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
        const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
        const logoutMessage = document.getElementById('logoutMessage');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                login(e.target.username.value, e.target.password.value);
            });
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                register(e.target.regUsername.value, e.target.regPassword.value, e.target.confirmPassword.value);
            });
            showRegisterBtn.addEventListener('click', () => {
                loginContainer.classList.add('opacity-0', 'pointer-events-none');
                registerContainer.classList.remove('opacity-0', 'pointer-events-none');
            });
            showLoginBtn.addEventListener('click', () => {
                registerContainer.classList.add('opacity-0', 'pointer-events-none');
                loginContainer.classList.remove('opacity-0', 'pointer-events-none');
            });

            searchInput.addEventListener('input', () => renderBooks());
            categoryFilter.addEventListener('change', () => renderBooks());
            
            bookForm.addEventListener('submit', handleBookFormSubmit);
            coverInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        coverPreview.src = event.target.result;
                        bookForm.elements.cover.value = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            cancelDeleteBtn.addEventListener('click', () => confirmDeleteModal.classList.add('hidden'));
            confirmDeleteBtn.addEventListener('click', () => {
                if (bookToDeleteId) {
                    books = books.filter(b => b.id !== bookToDeleteId);
                    showToast("Buku berhasil dihapus.");
                    renderAdminBookList();
                    renderBooks(); // Update main book list
                    bookToDeleteId = null;
                }
                confirmDeleteModal.classList.add('hidden');
            });
            
            cancelLogoutBtn.addEventListener('click', closeLogoutModal);
            confirmLogoutBtn.addEventListener('click', confirmLogout);

            // Close notifications panel if clicked outside
            document.addEventListener('click', function(event) {
                const notificationBtn = document.getElementById('notificationBtn');
                // Check if notificationBtn exists before trying to access properties
                if (notificationBtn) {
                    const isClickInside = notificationsPanel.contains(event.target) || notificationBtn.contains(event.target);
                    if (!isClickInside && !notificationsPanel.classList.contains('hidden')) {
                        notificationsPanel.classList.add('hidden');
                    }
                }
            });
        });

        // --- AUTHENTICATION ---
        function login(username, password) {
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                authOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loginError.classList.add('hidden');
                
                loginHistory.push({ username: user.username, timestamp: new Date().toISOString() });

                userInfo.innerHTML = `
                    <div class="flex items-center justify-center gap-4 relative">
                        <span>Selamat datang, <span class="font-bold">${currentUser.username}</span>!</span>
                        <div class="relative">
                            <button onclick="toggleNotifications()" id="notificationBtn" class="relative text-gray-300 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                                <span id="notificationBadge" class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-xs font-semibold text-white hidden"></span>
                            </button>
                        </div>
                        ${currentUser.role === 'admin' ? `<button onclick="openAdminPanel()" class="text-sm font-semibold text-amber-400 hover:text-amber-300 transition-colors">[Panel Admin]</button>` : ''}
                        <button onclick="logout()" title="Logout" class="text-gray-300 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></button>
                    </div>
                `;
                
                populateCategories();
                navigateTo('home');
                renderUserNotifications();
            } else {
                loginError.classList.remove('hidden');
            }
        }
        function register(username, password, confirmPassword) {
            if (password !== confirmPassword) {
                registerError.textContent = "Kata sandi tidak cocok.";
                registerError.classList.remove('hidden');
                return;
            }
            if (users.some(u => u.username === username)) {
                registerError.textContent = "Nama pengguna sudah ada.";
                registerError.classList.remove('hidden');
                return;
            }
            const newUser = { username, password, role: "user" };
            users.push(newUser);
            showToast("Pendaftaran berhasil! Silakan login.");
            registerError.classList.add('hidden');
            
            // Switch back to login form after successful registration
            registerContainer.classList.add('opacity-0', 'pointer-events-none');
            loginContainer.classList.remove('opacity-0', 'pointer-events-none');
            registerForm.reset();
        }
        
        function logout() {
            logoutMessage.textContent = `Apakah Anda yakin ingin keluar, ${currentUser.username}? Buku-buku akan menantimu kembali!`;
            logoutModal.classList.remove('hidden');
        }
        window.logout = logout;

        function closeLogoutModal() {
            logoutModal.classList.add('hidden');
        }

        function confirmLogout() {
            currentUser = null;
            authOverlay.classList.remove('hidden');
            appContainer.classList.add('hidden');
            loginForm.reset();
            closeLogoutModal();
            showToast("Anda telah berhasil keluar.");
        }


        // --- UI & HELPERS ---
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-500 ease-in-out z-[90] ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toast.classList.remove('translate-x-[120%]');
            setTimeout(() => {
                toast.classList.add('translate-x-[120%]');
            }, 3000);
        }

        function renderUserNotifications() {
            if (!currentUser) return;
            
            const notificationBadge = document.getElementById('notificationBadge');
            if(!notificationBadge) return;

            const userNotifications = notifications.filter(n => n.username === currentUser.username);
            const unreadCount = userNotifications.filter(n => !n.read).length;

            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }

            if (userNotifications.length === 0) {
                notificationList.innerHTML = `<p class="p-4 text-center text-sm text-gray-500">Tidak ada notifikasi baru.</p>`;
            } else {
                notificationList.innerHTML = userNotifications.map(n => `
                    <div class="p-3 border-b last:border-b-0 ${!n.read ? 'bg-amber-50' : ''} hover:bg-gray-100 rounded-md">
                        <p class="text-sm">${n.message}</p>
                        <p class="text-xs text-gray-400 mt-1">${new Date(n.timestamp).toLocaleString('id-ID')}</p>
                    </div>
                `).join('');
            }
        }

        function toggleNotifications() {
            const isHidden = notificationsPanel.classList.toggle('hidden');
            if (!isHidden) {
                // Mark notifications as read when panel is opened
                notifications.forEach(n => {
                    if (n.username === currentUser.username) {
                        n.read = true;
                    }
                });
                // Re-render to update UI (remove badge)
                renderUserNotifications();
            }
        }
        window.toggleNotifications = toggleNotifications;


        function navigateTo(page) {
            pageContents.forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            navLinks.forEach(link => {
                if (link.dataset.page === page) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            // Render content for the specific page
            if (page === 'home') renderHomePage();
            if (page === 'books') renderBooks();
            if (page === 'profile') renderProfilePage();
            if (page === 'feedback') renderFeedbackPage();
        }
        window.navigateTo = navigateTo;
        
        // --- PAGE RENDERERS ---
        function renderHomePage() {
            // Sapaan Dinamis
            const currentHour = new Date().getHours();
            let welcomeMessage = "Selamat Datang di E-Library!";
            if (currentHour < 11) {
                welcomeMessage = "Selamat Pagi! ☀️ Waktunya memulai hari dengan buku baru.";
            } else if (currentHour < 15) {
                welcomeMessage = "Selamat Siang! 🌤️ Temukan bacaan menarik untuk menemani istirahatmu.";
            } else if (currentHour < 19) {
                welcomeMessage = "Selamat Sore! 🌆 Mari bersantai sejenak dengan cerita yang seru.";
            } else {
                welcomeMessage = "Selamat Malam! 🌙 Temukan buku yang pas untuk dibaca sebelum tidur.";
            }
            
            // Logika Buku Pilihan Hari Ini
            const today = new Date().getDate(); 
            const bookOfTheDay = books[today % books.length];

            const recentlyAdded = [...books].sort((a, b) => b.id - a.id).slice(0, 4);
            const mostPopular = [...books].slice(0, 4).sort(() => 0.5 - Math.random());
            
            pageHome.innerHTML = `
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-white font-serif">${welcomeMessage}</h2>
                </div>

                <!-- Bagian Buku Pilihan Hari Ini -->
                <div class="mb-16">
                    <div class="bg-gradient-to-br from-yellow-900 via-amber-900 to-yellow-950 p-8 rounded-3xl shadow-2xl flex flex-col md:flex-row items-center gap-8 text-white">
                        <div class="md:w-1/3 text-center">
                            <img src="${bookOfTheDay.cover}" alt="Sampul ${bookOfTheDay.title}" class="w-52 h-auto object-cover rounded-lg shadow-xl mx-auto transform hover:scale-105 transition-transform duration-300">
                        </div>
                        <div class="md:w-2/3 text-center md:text-left">
                            <h2 class="text-amber-300 font-bold text-xl mb-2 font-serif">Buku Pilihan Hari Ini</h2>
                            <h3 class="text-4xl font-bold mb-3 font-serif">${bookOfTheDay.title}</h3>
                            <p class="text-lg text-amber-200 mb-4">oleh ${bookOfTheDay.author}</p>
                            <p class="mb-6 text-amber-100 leading-relaxed">${bookOfTheDay.summary.substring(0, 150)}...</p>
                            <button onclick="openBookModal(${bookOfTheDay.id})" class="bg-amber-400 text-amber-900 font-bold py-3 px-6 rounded-lg hover:bg-amber-300 transition-colors shadow-lg">
                                Baca Sekarang
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-12">
                    <div>
                        <h2 class="text-3xl font-bold mb-6 text-white font-serif">Buku Baru</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                            ${recentlyAdded.map(book => `
                                <div class="book-card bg-stone-50/90 backdrop-blur-sm rounded-2xl overflow-hidden shadow-lg cursor-pointer" onclick="openBookModal(${book.id})">
                                    <img src="${book.cover}" alt="Sampul ${book.title}" class="w-full h-64 object-cover">
                                    <div class="p-4 text-gray-800">
                                        <h3 class="font-bold truncate font-serif">${book.title}</h3>
                                        <p class="text-sm text-gray-600">${book.author}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                     <div>
                        <h2 class="text-3xl font-bold mb-6 text-white font-serif">Paling Populer</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                            ${mostPopular.map(book => `
                                <div class="book-card bg-stone-50/90 backdrop-blur-sm rounded-2xl overflow-hidden shadow-lg cursor-pointer" onclick="openBookModal(${book.id})">
                                    <img src="${book.cover}" alt="Sampul ${book.title}" class="w-full h-64 object-cover">
                                    <div class="p-4 text-gray-800">
                                        <h3 class="font-bold truncate font-serif">${book.title}</h3>
                                        <p class="text-sm text-gray-600">${book.author}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderFeedbackPage() {
            pageFeedback.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">
                    <!-- Feedback Submission Form -->
                    <div class="lg:col-span-1">
                        <div class="p-8 bg-stone-50/90 backdrop-blur-sm rounded-2xl shadow-md text-gray-800">
                            <h2 class="text-2xl font-bold mb-6 font-serif">Kirim Masukan Anda</h2>
                            <form id="feedbackForm" class="space-y-4">
                                <div>
                                    <label for="feedbackCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                                    <select id="feedbackCategory" name="category" required class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                        <option value="Saran Fitur">Saran Fitur</option>
                                        <option value="Laporan Bug">Laporan Bug</option>
                                        <option value="Koleksi Buku">Koleksi Buku</option>
                                        <option value="Lainnya">Lainnya</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="feedbackMessage" class="block text-sm font-medium text-gray-700 mb-1">Pesan Anda</label>
                                    <textarea id="feedbackMessage" name="message" rows="5" required placeholder="Tuliskan saran atau masukan Anda di sini..." class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-amber-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-800 transition-colors">
                                    Kirim Masukan
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Feedback List -->
                    <div class="lg:col-span-2">
                         <h2 class="text-3xl font-bold mb-6 text-white font-serif">Daftar Saran & Masukan</h2>
                         <div id="feedbackListContainer" class="space-y-4">
                            <!-- Feedback items will be rendered here -->
                         </div>
                    </div>
                </div>
            `;
            renderFeedbackList();
            document.getElementById('feedbackForm').addEventListener('submit', handleFeedbackSubmit);
        }

        function renderFeedbackList() {
            const container = document.getElementById('feedbackListContainer');
            if (!container) return;

            if (feedback.length === 0) {
                container.innerHTML = `<div class="p-8 bg-stone-50/90 backdrop-blur-sm rounded-2xl text-center text-gray-500"><p>Belum ada saran atau masukan yang dikirim.</p></div>`;
                return;
            }

            container.innerHTML = feedback.map(item => {
                const statusInfo = {
                    new: { text: 'Baru', class: 'bg-blue-100 text-blue-800' },
                    read: { text: 'Dibaca', class: 'bg-gray-100 text-gray-800' },
                    in_progress: { text: 'Dikerjakan', class: 'bg-yellow-100 text-yellow-800' },
                    done: { text: 'Selesai', class: 'bg-green-100 text-green-800' },
                };
                
                const currentStatus = statusInfo[item.status] || statusInfo['new'];

                return `
                    <div class="p-6 bg-stone-50/90 backdrop-blur-sm rounded-2xl shadow-sm text-gray-800">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <p class="font-bold text-lg">${item.username}</p>
                                <p class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString('id-ID')}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusInfo[item.status]?.class || ''}">${statusInfo[item.status]?.text || 'Baru'}</span>
                                <p class="text-sm font-semibold mt-1">${item.category}</p>
                            </div>
                        </div>
                        <p class="text-gray-700 whitespace-pre-wrap">${item.message}</p>
                    </div>
                `;
            }).join('');
        }

        function handleFeedbackSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const newFeedback = {
                id: Date.now(),
                username: currentUser.username,
                category: form.category.value,
                message: form.message.value,
                timestamp: new Date().toISOString(),
                status: 'new'
            };
            feedback.unshift(newFeedback);
            showToast('Terima kasih! Masukan Anda telah berhasil dikirim.');
            form.reset();
            renderFeedbackList();
            if(!adminPanelModal.classList.contains('hidden')) {
                renderAdminFeedbackList();
            }
        }

        function renderProfilePage() {
            const currentlyBorrowed = books.filter(b => b.status === 'borrowed' && b.borrowedBy === currentUser.username);
            const userBorrowHistory = borrowHistory.filter(h => h.username === currentUser.username && h.returnedAt);
            const totalBorrowedCount = userBorrowHistory.length;
            const readingStreak = 7; // Data dummy

            // --- Kalkulasi baru untuk "Perjalanan Membaca" ---
            const readingGoal = 20; // Menetapkan target tahunan
            const progressPercentage = Math.min((totalBorrowedCount / readingGoal) * 100, 100);

            // Menghitung genre favorit
            let favoriteGenre = "Belum Ada";
            if (userBorrowHistory.length > 0) {
                const genreCounts = userBorrowHistory.reduce((acc, historyItem) => {
                    const bookDetails = books.find(b => b.id === historyItem.bookId);
                    if (bookDetails) {
                        acc[bookDetails.category] = (acc[bookDetails.category] || 0) + 1;
                    }
                    return acc;
                }, {});
                
                if (Object.keys(genreCounts).length > 0) {
                    favoriteGenre = Object.keys(genreCounts).reduce((a, b) => genreCounts[a] > genreCounts[b] ? a : b);
                }
            }

            pageProfile.innerHTML = `
                <div class="max-w-5xl mx-auto space-y-8">
                    <!-- Kartu Profil Utama -->
                    <div class="p-8 bg-stone-50/90 backdrop-blur-sm rounded-2xl shadow-md text-gray-800 flex flex-col md:flex-row items-center gap-6">
                        <div class="w-28 h-28 bg-amber-700 rounded-full flex items-center justify-center text-white text-5xl font-bold flex-shrink-0">
                            ${currentUser.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="text-center md:text-left">
                            <h2 class="text-4xl font-bold font-serif">${currentUser.username}</h2>
                            <p class="text-gray-500 capitalize">Peran: ${currentUser.role}</p>
                            <p class="text-sm text-gray-400 mt-1">Bergabung sejak: Oktober 2025</p>
                        </div>
                    </div>

                    <!-- Perjalanan Membaca -->
                    <div class="p-8 bg-stone-50/90 backdrop-blur-sm rounded-2xl shadow-md text-gray-800">
                        <h3 class="text-2xl font-bold mb-6 font-serif text-center">Perjalanan Membaca Saya</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Rentetan Membaca -->
                            <div class="text-center p-4 bg-orange-100 rounded-lg text-orange-800 border border-orange-200">
                                <p class="text-4xl font-bold flex items-center justify-center gap-2">
                                    ${readingStreak} <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M14.5 4.5c.9-.9 2.1-.9 3 0s.9 2.1 0 3L13 12V8.5C13 7 14.5 4.5 14.5 4.5z"/><path d="M10.5 9.5c.9-.9 2.1-.9 3 0s.9 2.1 0 3L9 17v-4.5c0-1.5 1.5-4 1.5-4z"/><path d="M18 12.5c.9-.9 2.1-.9 3 0s.9 2.1 0 3l-3.5 3.5c-.9.9-2.1.9-3 0s-.9-2.1 0-3l3.5-3.5z"/><path d="M6.5 17.5c.9-.9 2.1-.9 3 0s.9 2.1 0 3L6 24l-3-3 3.5-3.5z"/></svg>
                                </p>
                                <p class="text-orange-600 font-semibold mt-1">Rentetan Membaca</p>
                            </div>
                             <!-- Genre Favorit -->
                            <div class="text-center p-4 bg-amber-100 rounded-lg text-amber-800 border border-amber-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600 mx-auto mb-2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                <p class="text-amber-800 font-semibold mt-1">Genre Favorit</p>
                                <p class="text-lg font-bold">${favoriteGenre}</p>
                            </div>
                            <!-- Target Bacaan -->
                            <div class="md:col-span-3 p-4 bg-gray-100 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-gray-600 font-semibold">Target Bacaan Tahunan</p>
                                    <p class="font-bold text-gray-800">${totalBorrowedCount} / ${readingGoal} buku</p>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div class="bg-amber-600 h-4 rounded-full" style="width: ${progressPercentage}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Buku yang Sedang Dipinjam -->
                    <div class="p-8 bg-stone-50/90 backdrop-blur-sm rounded-2xl shadow-md text-gray-800">
                        <h3 class="text-2xl font-bold mb-6 font-serif">Sedang Dibaca</h3>
                        ${currentlyBorrowed.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${currentlyBorrowed.map(book => `
                                    <div class="flex items-center gap-4 p-4 bg-white rounded-xl shadow">
                                        <img src="${book.cover}" alt="${book.title}" class="w-20 h-28 object-cover rounded-md flex-shrink-0">
                                        <div class="flex-grow">
                                            <p class="font-bold font-serif">${book.title}</p>
                                            <p class="text-sm text-gray-500">oleh ${book.author}</p>
                                            <p class="text-xs text-gray-400 mt-2">Dipinjam pada: ${new Date(book.borrowedAt).toLocaleDateString('id-ID')}</p>
                                            <button onclick="returnBook(${book.id})" class="mt-2 text-sm bg-green-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-green-600 w-full">Kembalikan</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-center text-gray-500 py-8">Anda tidak sedang meminjam buku. Ayo jelajahi koleksi kami!</p>
                        `}
                    </div>

                    <!-- Riwayat Peminjaman -->
                    <div class="p-8 bg-stone-50/90 backdrop-blur-sm rounded-2xl shadow-md text-gray-800">
                        <h3 class="text-2xl font-bold mb-4 font-serif">Riwayat Peminjaman Saya</h3>
                        ${userBorrowHistory.length > 0 ? `
                            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                ${userBorrowHistory.map(item => `
                                    <div class="p-4 bg-gray-50 rounded-lg flex justify-between items-center">
                                       <div>
                                            <p class="font-semibold font-serif">${item.bookTitle}</p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                <span>${new Date(item.borrowedAt).toLocaleDateString('id-ID')}</span> - <span>${new Date(item.returnedAt).toLocaleDateString('id-ID')}</span>
                                            </p>
                                       </div>
                                       <span class="text-green-600">
                                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                                       </span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-center text-gray-500 py-8">Anda belum memiliki riwayat peminjaman.</p>
                        `}
                    </div>
                </div>
            `;
        }

        // --- BOOK MANAGEMENT & UI ---
        function populateCategories() {
            const categories = ['all', ...new Set(books.map(book => book.category))];
            categoryFilter.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category === 'all' ? 'Semua Kategori' : category;
                categoryFilter.appendChild(option);
            });
        }

        function renderBooks() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;

            const filteredBooks = books.filter(book => {
                const titleMatch = book.title.toLowerCase().includes(searchTerm);
                const authorMatch = book.author.toLowerCase().includes(searchTerm);
                const categoryMatch = selectedCategory === 'all' || book.category === selectedCategory;
                return (titleMatch || authorMatch) && categoryMatch;
            });

            bookListContainer.innerHTML = ''; // Ganti ke container baru
            if (filteredBooks.length > 0) {
                noResults.classList.add('hidden');
                
                let shelfHTML = '<div class="bookshelf">';
                filteredBooks.forEach((book, index) => {
                    const isNew = book.id > 15; // Logika untuk buku baru
                    const isPopular = [2, 8, 12, 19].includes(book.id); // Logika untuk buku populer

                    shelfHTML += `
                        <div class="book-card bg-stone-50/90 backdrop-blur-sm rounded-lg overflow-hidden shadow-lg cursor-pointer group relative" onclick="openBookModal(${book.id})">
                            ${isNew ? `<div class="absolute top-2 left-2 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full z-10">BARU</div>` : ''}
                            ${isPopular ? `<div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full z-10">POPULER</div>` : ''}
                            
                            <img src="${book.cover}" alt="Sampul ${book.title}" class="w-full h-64 object-cover">
                            
                            <div class="p-4 text-gray-800 relative z-10 bg-stone-50/90">
                                <h3 class="font-bold truncate font-serif">${book.title}</h3>
                                <p class="text-sm text-gray-600">${book.author}</p>
                            </div>
                            
                            <!-- Overlay Info Cepat -->
                            <div class="absolute inset-0 bg-black/70 flex flex-col justify-center items-center text-center p-4 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                <h4 class="font-bold font-serif">${book.category}</h4>
                                <p class="text-sm mt-1">${book.pages} halaman</p>
                                <button class="mt-4 bg-amber-600 px-3 py-1 rounded-full text-sm">Lihat Detail</button>
                            </div>
                        </div>
                    `;
                });
                shelfHTML += '</div>';
                bookListContainer.innerHTML = shelfHTML;

            } else {
                noResults.classList.remove('hidden');
            }
        }

        function openBookModal(bookId) {
            const book = books.find(b => b.id === bookId);
            if (!book) return;

            let actionButton = '';
            if (book.status === 'available') {
                actionButton = `<button onclick="borrowBook(${book.id})" class="w-full bg-amber-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-800 transition-colors">Pinjam Buku</button>`;
            } else if (book.borrowedBy === currentUser.username) {
                actionButton = `<button onclick="returnBook(${book.id})" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">Kembalikan Buku</button>`;
            } else {
                actionButton = `<button class="w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg cursor-not-allowed" disabled>Sedang Dipinjam oleh ${book.borrowedBy}</button>`;
            }

            modalContent.innerHTML = `
                <button onclick="closeBookModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="flex-shrink-0 md:w-1/3">
                        <img src="${book.cover}" alt="Sampul ${book.title}" class="w-full h-auto object-cover rounded-lg shadow-lg">
                    </div>
                    <div class="flex flex-col md:w-2/3">
                        <h2 class="text-3xl font-bold mb-1 font-serif">${book.title}</h2>
                        <p class="text-lg text-gray-600 mb-2">oleh ${book.author} (${book.year})</p>
                        <div class="flex items-center gap-4 text-sm text-gray-500 mb-4">
                            <span>${book.category}</span>
                            <span>•</span>
                            <span>${book.pages} halaman</span>
                        </div>
                        <p class="text-base text-gray-700 flex-grow mb-6">${book.summary}</p>
                        ${actionButton}
                    </div>
                </div>
            `;
            bookModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        window.openBookModal = openBookModal;

        function closeBookModal() {
            modalContent.parentElement.classList.add('modal-leave');
            setTimeout(() => {
                bookModal.classList.add('hidden');
                modalContent.parentElement.classList.remove('modal-leave');
                document.body.style.overflow = '';
            }, 300);
        }
        window.closeBookModal = closeBookModal;

        function borrowBook(bookId) {
            const book = books.find(b => b.id === bookId);
            if (book && book.status === 'available') {
                book.status = 'borrowed';
                book.borrowedBy = currentUser.username;
                book.borrowedAt = new Date().toISOString();
                
                borrowHistory.push({
                    id: Date.now(),
                    username: currentUser.username,
                    bookId: book.id,
                    bookTitle: book.title,
                    borrowedAt: book.borrowedAt,
                    returnedAt: null
                });
                
                showToast(`Anda berhasil meminjam "${book.title}".`);
                closeBookModal();
                 if (!document.getElementById('page-books').classList.contains('hidden')) {
                    renderBooks();
                }
                if (!document.getElementById('page-profile').classList.contains('hidden')) {
                    renderProfilePage();
                }
            } else {
                showToast("Buku ini tidak tersedia untuk dipinjam.", true);
            }
        }
        window.borrowBook = borrowBook;

        function returnBook(bookId, fromAdmin = false) {
            const book = books.find(b => b.id === bookId);
            if (book && (book.borrowedBy === currentUser.username || fromAdmin)) {
                const historyEntry = borrowHistory.find(h => h.bookId === bookId && h.returnedAt === null);
                if (historyEntry) {
                    historyEntry.returnedAt = new Date().toISOString();
                }

                book.status = 'available';
                book.borrowedBy = null;
                book.borrowedAt = null;

                showToast(`"${book.title}" telah dikembalikan.`);
                if(!fromAdmin) {
                    closeBookModal();
                }
                
                if (!document.getElementById('page-books').classList.contains('hidden')) {
                    renderBooks();
                }
                if (!document.getElementById('page-profile').classList.contains('hidden')) {
                    renderProfilePage();
                }

                if (!adminPanelModal.classList.contains('hidden')) {
                    renderAdminBorrowedBooksList();
                    renderAdminBorrowHistory();
                    renderAdminBookList();
                }
            } else {
                showToast("Anda tidak dapat mengembalikan buku ini.", true);
            }
        }
        window.returnBook = returnBook;

        // --- ADMIN PANEL & FORMS ---
        function openAdminPanel() { 
            renderAdminDashboard();
            renderAdminBookList();
            renderUserList();
            renderAdminFeedbackList();
            renderAdminBorrowedBooksList();
            renderAdminBorrowHistory();
            renderAdminLoginHistory();
            switchTab('dashboard');
            adminPanelModal.classList.remove('hidden'); 
        }
        window.openAdminPanel = openAdminPanel;
        function closeAdminPanel() { adminPanelModal.classList.add('hidden'); }

        function renderAdminDashboard() {
            const content = document.getElementById('contentDashboard');
            const totalBooks = books.length;
            const borrowedCount = books.filter(b => b.status === 'borrowed').length;
            const userCount = users.length;
            const newFeedbackCount = feedback.filter(f => f.status === 'new').length;

            content.innerHTML = `
                <h2 class="text-3xl font-bold font-serif text-stone-800 mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stat Card: Total Buku -->
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <div class="bg-amber-100 p-3 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                        </div>
                        <div>
                            <p class="text-sm text-stone-500">Total Buku</p>
                            <p class="text-2xl font-bold text-stone-800">${totalBooks}</p>
                        </div>
                    </div>
                    <!-- Stat Card: Buku Dipinjam -->
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <div class="bg-blue-100 p-3 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="m17 13 5 5-5 5"/><path d="M4 18v-1a4 4 0 0 1 4-4h10"/></svg>
                        </div>
                        <div>
                            <p class="text-sm text-stone-500">Buku Dipinjam</p>
                            <p class="text-2xl font-bold text-stone-800">${borrowedCount}</p>
                        </div>
                    </div>
                    <!-- Stat Card: Total Pengguna -->
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <div class="bg-green-100 p-3 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        </div>
                        <div>
                            <p class="text-sm text-stone-500">Total Pengguna</p>
                            <p class="text-2xl font-bold text-stone-800">${userCount}</p>
                        </div>
                    </div>
                    <!-- Stat Card: Masukan Baru -->
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <div class="bg-red-100 p-3 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </div>
                        <div>
                            <p class="text-sm text-stone-500">Masukan Baru</p>
                            <p class="text-2xl font-bold text-stone-800">${newFeedbackCount}</p>
                        </div>
                    </div>
                </div>

                <h3 class="text-2xl font-bold font-serif text-stone-800 mb-4">Aktivitas Terbaru</h3>
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <p class="text-center text-gray-500">Fitur aktivitas terbaru akan segera hadir!</p>
                </div>
            `;
        }


        function renderAdminBookList() {
            adminBookList.innerHTML = '';
            books.forEach(book => {
                adminBookList.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-lg mb-4 flex items-center gap-4">
                         <img src="${book.cover}" alt="Sampul ${book.title}" class="w-16 h-24 object-cover rounded-md">
                        <div class="flex-grow">
                            <p class="font-bold font-serif">${book.title}</p>
                            <p class="text-sm text-gray-500">${book.author}</p>
                             <p class="text-xs text-gray-500 mt-1">${book.category}</p>
                        </div>
                        <p class="text-sm w-40 text-center">${book.status === 'available' ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-semibold">Tersedia</span>' : `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-semibold">Dipinjam oleh ${book.borrowedBy}</span>`}</p>
                        <div class="flex gap-2">
                            <button onclick="openBookForm(${book.id})" title="Edit" class="p-2 text-blue-600 bg-blue-100 hover:bg-blue-200 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                            <button onclick="confirmDelete(${book.id})" title="Hapus" class="p-2 text-red-600 bg-red-100 hover:bg-red-200 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </div>
                    </div>
                `;
            });
        }
        function renderUserList() {
            adminUserList.innerHTML = '';
            users.forEach(user => {
                const borrowCount = borrowHistory.filter(h => h.username === user.username && h.returnedAt).length;
                const actions = user.role !== 'admin' ? `<button onclick="openUserHistoryModal('${user.username}')" class="text-sm font-semibold text-amber-700 hover:underline">Lihat Riwayat</button>` : '';
                adminUserList.innerHTML += `
                     <div class="bg-white p-4 rounded-xl shadow-lg mb-4 flex items-center gap-4">
                        <div class="w-12 h-12 bg-amber-700 rounded-full flex items-center justify-center text-white text-xl font-bold">
                           ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-grow">
                            <p class="font-bold font-serif">${user.username}</p>
                            <p class="text-sm capitalize text-gray-500">${user.role}</p>
                        </div>
                        <p class="text-sm text-gray-600 w-32 text-center">${borrowCount} buku dibaca</p>
                        <div class="w-32 text-right">${actions}</div>
                    </div>`;
            });
        }
        function renderAdminFeedbackList() {
            adminFeedbackList.innerHTML = '';
            if (feedback.length === 0) {
                adminFeedbackList.innerHTML = `<p class="text-center text-gray-500 p-4">Tidak ada masukan.</p>`;
                return;
            }

            feedback.forEach(item => {
                adminFeedbackList.innerHTML += `
                    <div class="p-4 bg-white rounded-xl shadow-lg mb-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold font-serif">${item.username} <span class="text-sm text-gray-500 font-normal">- ${item.category}</span></p>
                                <p class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleString('id-ID')}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <select onchange="updateFeedbackStatus(${item.id}, this.value)" class="text-xs border-gray-300 rounded-md shadow-sm focus:border-amber-300 focus:ring focus:ring-amber-200 focus:ring-opacity-50">
                                    <option value="new" ${item.status === 'new' ? 'selected' : ''}>Baru</option>
                                    <option value="read" ${item.status === 'read' ? 'selected' : ''}>Dibaca</option>
                                    <option value="in_progress" ${item.status === 'in_progress' ? 'selected' : ''}>Dikerjakan</option>
                                    <option value="done" ${item.status === 'done' ? 'selected' : ''}>Selesai</option>
                                </select>
                                <button onclick="deleteFeedback(${item.id})" title="Hapus" class="p-2 text-red-600 bg-red-100 hover:bg-red-200 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                        <p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">${item.message}</p>
                    </div>
                `;
            });
        }
        window.updateFeedbackStatus = (id, status) => {
            const item = feedback.find(f => f.id === id);
            if (item) {
                item.status = status;
                showToast(`Status masukan dari ${item.username} diperbarui.`);
                renderFeedbackList(); // re-render public list if visible
            }
        };
        window.deleteFeedback = (id) => {
            feedback = feedback.filter(f => f.id !== id);
            showToast('Masukan telah dihapus.');
            renderAdminFeedbackList();
            renderFeedbackList(); // re-render public list if visible
        };

        function requestReturn(bookId) {
            const book = books.find(b => b.id === bookId);
            if (book && book.borrowedBy) {
                const newNotification = {
                    id: Date.now(),
                    username: book.borrowedBy,
                    message: `Admin meminta Anda untuk mengembalikan buku "${book.title}".`,
                    timestamp: new Date().toISOString(),
                    read: false,
                };
                notifications.unshift(newNotification);
                showToast(`Permintaan pengembalian untuk buku "${book.title}" telah dikirim ke ${book.borrowedBy}.`);
                // In a real app with websockets, you'd push this update to the user.
                // Here, the user will see it on their next page load/render if they are logged in.
            }
        }
        window.requestReturn = requestReturn;

        function renderAdminBorrowedBooksList() {
            const currentlyBorrowed = books.filter(b => b.status === 'borrowed');
            if (currentlyBorrowed.length === 0) {
                adminBorrowedBooksList.innerHTML = `<p class="text-center text-gray-500 p-4">Tidak ada buku yang sedang dipinjam.</p>`;
                return;
            }
            adminBorrowedBooksList.innerHTML = currentlyBorrowed.map(book => {
                const borrowedDate = new Date(book.borrowedAt);
                return `
                    <div class="bg-white p-4 rounded-xl shadow-lg mb-4 flex items-center gap-4">
                        <div class="flex-grow">
                            <p class="font-bold font-serif">${book.title}</p>
                            <p class="text-sm text-gray-500">Dipinjam oleh: ${book.borrowedBy}</p>
                        </div>
                        <p class="text-sm text-gray-600 w-40 text-center">${borrowedDate.toLocaleDateString('id-ID')}</p>
                        <div class="flex gap-2">
                             <button onclick="requestReturn(${book.id})" class="text-sm bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-yellow-600">Minta Kembali</button>
                             <button onclick="returnBook(${book.id}, true)" class="text-sm bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600">Tandai Kembali</button>
                        </div>
                    </div>
                `
            }).join('');
        }
        function renderAdminBorrowHistory() {
            if (borrowHistory.length === 0) {
                adminBorrowHistoryList.innerHTML = `<p class="text-center text-gray-500 p-4">Riwayat peminjaman kosong.</p>`;
                return;
            }
            adminBorrowHistoryList.innerHTML = borrowHistory.map(h => `
                 <div class="bg-white p-4 rounded-xl shadow-lg mb-4 flex items-center gap-4">
                    <div class="flex-grow">
                        <p class="font-bold font-serif">${h.bookTitle}</p>
                        <p class="text-sm text-gray-500">Oleh: ${h.username}</p>
                    </div>
                    <p class="text-sm text-gray-600 w-40 text-center">Pinjam: ${new Date(h.borrowedAt).toLocaleDateString('id-ID')}</p>
                    <p class="text-sm text-gray-600 w-40 text-center">Kembali: ${h.returnedAt ? new Date(h.returnedAt).toLocaleDateString('id-ID') : '-'}</p>
                </div>
            `).join('');
        }
        function renderAdminLoginHistory() {
            if (loginHistory.length === 0) {
                adminLoginHistoryList.innerHTML = `<p class="text-center text-gray-500 p-4">Riwayat login kosong.</p>`;
                return;
            }
            adminLoginHistoryList.innerHTML = loginHistory.map(l => `
                 <div class="bg-white p-4 rounded-xl shadow-lg mb-4 flex items-center gap-4">
                    <p class="font-bold font-serif flex-grow">${l.username}</p>
                    <p class="text-sm text-gray-600">${new Date(l.timestamp).toLocaleString('id-ID')}</p>
                </div>
            `).join('');
        }
        
        function switchTab(tabName) {
            const capitalizedTabName = tabName.charAt(0).toUpperCase() + tabName.slice(1);
            adminTabs.forEach(tab => {
                if(tab.id === `tab${capitalizedTabName}`) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            adminTabContents.forEach(content => {
                if(content.id === `content${capitalizedTabName}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        }
        window.switchTab = switchTab;

        function openBookForm(bookId = null) {
            bookForm.reset();
            coverPreview.src = 'https://placehold.co/200x300/e2e8f0/94a3b8?text=Pratinjau+Sampul';
            if (bookId) {
                bookToEditId = bookId;
                const book = books.find(b => b.id === bookId);
                bookFormTitle.textContent = "Edit Buku";
                bookFormSubmitBtn.textContent = "Simpan Perubahan";
                bookForm.elements.id.value = book.id;
                bookForm.elements.title.value = book.title;
                bookForm.elements.author.value = book.author;
                bookForm.elements.year.value = book.year;
                bookForm.elements.pages.value = book.pages;
                bookForm.elements.category.value = book.category;
                bookForm.elements.summary.value = book.summary;
                bookForm.elements.cover.value = book.cover;
                coverPreview.src = book.cover;
            } else {
                bookToEditId = null;
                bookFormTitle.textContent = "Tambah Buku Baru";
                bookFormSubmitBtn.textContent = "Tambah Buku";
            }
            bookFormModal.classList.remove('hidden');
        }
        window.openBookForm = openBookForm;
        function closeBookForm() {
            bookFormModal.classList.add('hidden');
        }
        window.closeBookForm = closeBookForm;
        function handleBookFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const bookData = Object.fromEntries(formData.entries());

            if (bookToEditId) {
                // Edit
                const index = books.findIndex(b => b.id === bookToEditId);
                books[index] = { ...books[index], ...bookData, id: books[index].id, year: parseInt(bookData.year), pages: parseInt(bookData.pages) };
                showToast("Buku berhasil diperbarui.");
            } else {
                // Add
                const newBook = {
                    ...bookData,
                    id: Date.now(),
                    status: 'available',
                    borrowedBy: null,
                    borrowedAt: null,
                    year: parseInt(bookData.year),
                    pages: parseInt(bookData.pages)
                };
                books.unshift(newBook);
                showToast("Buku baru berhasil ditambahkan.");
            }
            closeBookForm();
            renderAdminBookList();
            renderBooks();
            populateCategories(); // Update categories if new one was added
        }
        
        function confirmDelete(bookId) {
            bookToDeleteId = bookId;
            const book = books.find(b => b.id === bookId);
            confirmDeleteText.textContent = `Apakah Anda yakin ingin menghapus buku "${book.title}"?`;
            confirmDeleteModal.classList.remove('hidden');
        }
        window.confirmDelete = confirmDelete;

        function openUserHistoryModal(username) {
            const userBorrowHistory = borrowHistory.filter(h => h.username === username);
            userHistoryModalTitle.textContent = `Riwayat Peminjaman untuk ${username}`;
            if (userBorrowHistory.length === 0) {
                 userHistoryModalContent.innerHTML = `<p class="text-center text-gray-500">Pengguna ini belum pernah meminjam buku.</p>`;
            } else {
                 userHistoryModalContent.innerHTML = userBorrowHistory.map(h => `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="font-semibold">${h.bookTitle}</p>
                        <p class="text-sm text-gray-500">Dipinjam: ${new Date(h.borrowedAt).toLocaleDateString('id-ID')}</p>
                        <p class="text-sm text-gray-500">Dikembalikan: ${h.returnedAt ? new Date(h.returnedAt).toLocaleDateString('id-ID') : 'Belum kembali'}</p>
                    </div>
                `).join('');
            }
            userHistoryModal.classList.remove('hidden');
        }
        window.openUserHistoryModal = openUserHistoryModal;
        function closeUserHistoryModal() {
            userHistoryModal.classList.add('hidden');
        }
        window.closeUserHistoryModal = closeUserHistoryModal;

    </script>
</body>
</html>

